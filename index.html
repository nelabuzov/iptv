<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>IPTV Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
<style>
  body { margin: 0; font-family: sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; height: 100vh; }
  header { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; background: #1e1e1e; gap: 10px; }
  #nowPlaying { display: flex; align-items: center; min-width: 0; margin-left: -10px; }
  #currentLogo { display: block; height: 50px; width: auto; margin: 0; padding: 0; }
  /* –æ–±–Ω–æ–≤–ª–µ–Ω–æ */
  #currentTitle {
    margin-left: 10px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50vw;
    color: #1e1e1e; background: #444; padding: 6px; border-radius: 12px; text-transform: uppercase;
  }
  #emojiDescription { font-size: 14px; opacity: 0.8; white-space: nowrap; }
  main { display: flex; flex: 1; overflow: hidden; }
  #playerContainer { flex: 3; display: flex; align-items: center; justify-content: center; background: black; }
  video { width: 100%; height: 100%; background: black; }
  video::-webkit-media-controls-timeline,
  video::-webkit-media-controls-time-remaining-display,
  video::-webkit-media-controls-current-time-display { display: none !important; }
  #rightPanel { flex: 1; background: #181818; display: flex; flex-direction: column; overflow: hidden; }
  #tools { display: flex; gap: 8px; padding: 10px; background: #1e1e1e; align-items: center; }
  #searchInput { flex: 1; padding: 6px; border-radius: 12px; border: none; outline: none; background: #2a2a2a; color: white; }
  #randomBtn, #backBtn { padding: 6px 10px; border: none; border-radius: 12px; background: #333; color: white; cursor: pointer; }
  #backBtn { display: none; }
  #channelList { flex: 1; overflow-y: auto; padding: 0 10px; }
  .channel { display: flex; align-items: center; padding: 12px; border-radius: 12px; cursor: pointer; gap: 8px; margin: 0; }
  .channel:hover { background: #333; }
  .channel.active { background: #444; }
  .channel-flag { flex-shrink: 0; font-size: 16px; line-height: 1; width: 30px; display: flex; align-items: center; justify-content: center; }
  .channel-flag img { width: 18px; height: 18px; display: block; }
  .channel-text { flex: 1; word-break: break-word; }
  .channel-emoji { flex-shrink: 0; font-size: 16px; margin-left: 8px; display: flex; align-items: center; }
  .channel-emoji img { width: 16px; height: 16px; display: block; }
  #channelList::-webkit-scrollbar { width: 8px; }
  #channelList::-webkit-scrollbar-thumb { background: #444; border-radius: 8px; }
  #channelList::-webkit-scrollbar-track { background: transparent; }
</style>
</head>
<body>
  <header>
    <div id="nowPlaying">
      <img id="currentLogo" alt="" src="" />
      <div id="currentTitle"></div>
    </div>
    <div id="emojiDescription">
      üïõ ‚Äî Not 24/7 &nbsp;&nbsp; üåê ‚Äî Geo-blocked
    </div>
  </header>
  <main>
    <div id="playerContainer">
      <video id="videoPlayer" controls autoplay></video>
    </div>
    <div id="rightPanel">
      <div id="tools">
        <button id="backBtn">‚óÄ</button>
        <input id="searchInput" type="text" placeholder="Filter Countries">
        <button id="randomBtn">üé≤</button>
      </div>
      <div id="channelList"></div>
    </div>
  </main>

<script>
const list = document.getElementById('channelList');
const player = document.getElementById('videoPlayer');
const searchInput = document.getElementById('searchInput');
const randomBtn = document.getElementById('randomBtn');
const backBtn = document.getElementById('backBtn');
const currentLogo = document.getElementById('currentLogo');
const currentTitle = document.getElementById('currentTitle');

let channels = [];
let hls = null;
let currentCountry = undefined; // undefined => –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã

/* === countryMap (–º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ JS) === */
const countryMap={"üá¶üá´":{domain:"af",name:"Afghanistan"},"üá¶üáΩ":{domain:"ax",name:"√Öland Islands"},"üá¶üá±":{domain:"al",name:"Albania"},"üá©üáø":{domain:"dz",name:"Algeria"},"üá¶üá∏":{domain:"as",name:"American Samoa"},"üá¶üá©":{domain:"ad",name:"Andorra"},"üá¶üá¥":{domain:"ao",name:"Angola"},"üá¶üáÆ":{domain:"ai",name:"Anguilla"},"üá¶üá∂":{domain:"aq",name:"Antarctica"},"üá¶üá¨":{domain:"ag",name:"Antigua & Barbuda"},"üá¶üá∑":{domain:"ar",name:"Argentina"},"üá¶üá≤":{domain:"am",name:"Armenia"},"üá¶üáº":{domain:"aw",name:"Aruba"},"üá¶üá®":{domain:"ac",name:"Ascension Island"},"üá¶üá∫":{domain:"au",name:"Australia"},"üá¶üáπ":{domain:"at",name:"Austria"},"üá¶üáø":{domain:"az",name:"Azerbaijan"},"üáßüá∏":{domain:"bs",name:"Bahamas"},"üáßüá≠":{domain:"bh",name:"Bahrain"},"üáßüá©":{domain:"bd",name:"Bangladesh"},"üáßüáß":{domain:"bb",name:"Barbados"},"üáßüáæ":{domain:"by",name:"Belarus"},"üáßüá™":{domain:"be",name:"Belgium"},"üáßüáø":{domain:"bz",name:"Belize"},"üáßüáØ":{domain:"bj",name:"Benin"},"üáßüá≤":{domain:"bm",name:"Bermuda"},"üáßüáπ":{domain:"bt",name:"Bhutan"},"üáßüá¥":{domain:"bo",name:"Bolivia"},"üáßüá¶":{domain:"ba",name:"Bosnia & Herzegovina"},"üáßüáº":{domain:"bw",name:"Botswana"},"üáßüáª":{domain:"bv",name:"Bouvet Island"},"üáßüá∑":{domain:"br",name:"Brazil"},"üáÆüá¥":{domain:"io",name:"British Indian Ocean Territory"},"üáªüá¨":{domain:"vg",name:"British Virgin Islands"},"üáßüá≥":{domain:"bn",name:"Brunei"},"üáßüá¨":{domain:"bg",name:"Bulgaria"},"üáßüá´":{domain:"bf",name:"Burkina Faso"},"üáßüáÆ":{domain:"bi",name:"Burundi"},"üá∞üá≠":{domain:"kh",name:"Cambodia"},"üá®üá≤":{domain:"cm",name:"Cameroon"},"üá®üá¶":{domain:"ca",name:"Canada"},"üáÆüá®":{domain:"ic",name:"Canary Islands"},"üá®üáª":{domain:"cv",name:"Cape Verde"},"üáßüá∂":{domain:"bq",name:"Caribbean Netherlands"},"üá∞üáæ":{domain:"ky",name:"Cayman Islands"},"üá®üá´":{domain:"cf",name:"Central African Republic"},"üá™üá¶":{domain:"ea",name:"Ceuta & Melilla"},"üáπüá©":{domain:"td",name:"Chad"},"üá®üá±":{domain:"cl",name:"Chile"},"üá®üá≥":{domain:"cn",name:"China"},"üá®üáΩ":{domain:"cx",name:"Christmas Island"},"üá®üáµ":{domain:"cp",name:"Clipperton Island"},"üá®üá®":{domain:"cc",name:"Cocos (Keeling) Islands"},"üá®üá¥":{domain:"co",name:"Colombia"},"üá∞üá≤":{domain:"km",name:"Comoros"},"üá®üá¨":{domain:"cg",name:"Congo - Brazzaville"},"üá®üá©":{domain:"cd",name:"Congo - Kinshasa"},"üá®üá∞":{domain:"ck",name:"Cook Islands"},"üá®üá∑":{domain:"cr",name:"Costa Rica"},"üá®üáÆ":{domain:"ci",name:"C√¥te d‚ÄôIvoire"},"üá≠üá∑":{domain:"hr",name:"Croatia"},"üá®üá∫":{domain:"cu",name:"Cuba"},"üá®üáº":{domain:"cw",name:"Cura√ßao"},"üá®üáæ":{domain:"cy",name:"Cyprus"},"üá®üáø":{domain:"cz",name:"Czechia"},"üá©üá∞":{domain:"dk",name:"Denmark"},"üá©üáØ":{domain:"dj",name:"Djibouti"},"üá©üá≤":{domain:"dm",name:"Dominica"},"üá©üá¥":{domain:"do",name:"Dominican Republic"},"üá™üá®":{domain:"ec",name:"Ecuador"},"üá™üá¨":{domain:"eg",name:"Egypt"},"üá∏üáª":{domain:"sv",name:"El Salvador"},"üá¨üá∂":{domain:"gq",name:"Equatorial Guinea"},"üá™üá∑":{domain:"er",name:"Eritrea"},"üá™üá™":{domain:"ee",name:"Estonia"},"üá∏üáø":{domain:"sz",name:"Eswatini"},"üá™üáπ":{domain:"et",name:"Ethiopia"},"üá™üá∫":{domain:"eu",name:"Europe"},"üá´üá∞":{domain:"fk",name:"Falkland Islands"},"üá´üá¥":{domain:"fo",name:"Faroe Islands"},"üá´üáØ":{domain:"fj",name:"Fiji"},"üá´üáÆ":{domain:"fi",name:"Finland"},"üá´üá∑":{domain:"fr",name:"France"},"üá¨üá´":{domain:"gf",name:"French Guiana"},"üáµüá´":{domain:"pf",name:"French Polynesia"},"üáπüá´":{domain:"tf",name:"French Southern Territories"},"üá¨üá¶":{domain:"ga",name:"Gabon"},"üá¨üá≤":{domain:"gm",name:"Gambia"},"üá¨üá™":{domain:"ge",name:"Georgia"},"üá©üá™":{domain:"de",name:"Germany"},"üá¨üá≠":{domain:"gh",name:"Ghana"},"üá¨üáÆ":{domain:"gi",name:"Gibraltar"},"üá¨üá∑":{domain:"gr",name:"Greece"},"üá¨üá±":{domain:"gl",name:"Greenland"},"üá¨üá©":{domain:"gd",name:"Grenada"},"üá¨üáµ":{domain:"gp",name:"Guadeloupe"},"üá¨üá∫":{domain:"gu",name:"Guam"},"üá¨üáπ":{domain:"gt",name:"Guatemala"},"üá¨üá¨":{domain:"gg",name:"Guernsey"},"üá¨üá≥":{domain:"gn",name:"Guinea"},"üá¨üáº":{domain:"gw",name:"Guinea-Bissau"},"üá¨üáæ":{domain:"gy",name:"Guyana"},"üá≠üáπ":{domain:"ht",name:"Haiti"},"üá≠üá≤":{domain:"hm",name:"Heard & McDonald Islands"},"üá≠üá≥":{domain:"hn",name:"Honduras"},"üá≠üá∞":{domain:"hk",name:"Hong Kong"},"üá≠üá∫":{domain:"hu",name:"Hungary"},"üáÆüá∏":{domain:"is",name:"Iceland"},"üáÆüá≥":{domain:"in",name:"India"},"üáÆüá©":{domain:"id",name:"Indonesia"},"üáÆüá∑":{domain:"ir",name:"Iran"},"üáÆüá∂":{domain:"iq",name:"Iraq"},"üáÆüá™":{domain:"ie",name:"Ireland"},"üáÆüá≤":{domain:"im",name:"Isle of Man"},"üáÆüá±":{domain:"il",name:"Israel"},"üáÆüáπ":{domain:"it",name:"Italy"},"üáØüá≤":{domain:"jm",name:"Jamaica"},"üáØüáµ":{domain:"jp",name:"Japan"},"üáØüá™":{domain:"je",name:"Jersey"},"üáØüá¥":{domain:"jo",name:"Jordan"},"üá∞üáø":{domain:"kz",name:"Kazakhstan"},"üá∞üá™":{domain:"ke",name:"Kenya"},"üá∞üáÆ":{domain:"ki",name:"Kiribati"},"üáΩüá∞":{domain:"xk",name:"Kosovo"},"üá∞üáº":{domain:"kw",name:"Kuwait"},"üá∞üá¨":{domain:"kg",name:"Kyrgyzstan"},"üá±üá¶":{domain:"la",name:"Laos"},"üá±üáª":{domain:"lv",name:"Latvia"},"üá±üáß":{domain:"lb",name:"Lebanon"},"üá±üá∏":{domain:"ls",name:"Lesotho"},"üá±üá∑":{domain:"lr",name:"Liberia"},"üá±üáæ":{domain:"ly",name:"Libya"},"üá±üáÆ":{domain:"li",name:"Liechtenstein"},"üá±üáπ":{domain:"lt",name:"Lithuania"},"üá±üá∫":{domain:"lu",name:"Luxembourg"},"üá≤üá¥":{domain:"mo",name:"Macau"},"üá≤üá¨":{domain:"mg",name:"Madagascar"},"üá≤üáº":{domain:"mw",name:"Malawi"},"üá≤üáæ":{domain:"my",name:"Malaysia"},"üá≤üáª":{domain:"mv",name:"Maldives"},"üá≤üá±":{domain:"ml",name:"Mali"},"üá≤üáπ":{domain:"mt",name:"Malta"},"üá≤üá≠":{domain:"mh",name:"Marshall Islands"},"üá≤üá∂":{domain:"mq",name:"Martinique"},"üá≤üá∑":{domain:"mr",name:"Mauritania"},"üá≤üá∫":{domain:"mu",name:"Mauritius"},"üáæüáπ":{domain:"yt",name:"Mayotte"},"üá≤üáΩ":{domain:"mx",name:"Mexico"},"üá´üá≤":{domain:"fm",name:"Micronesia"},"üá≤üá©":{domain:"md",name:"Moldova"},"üá≤üá®":{domain:"mc",name:"Monaco"},"üá≤üá≥":{domain:"mn",name:"Mongolia"},"üá≤üá™":{domain:"me",name:"Montenegro"},"üá≤üá∏":{domain:"ms",name:"Montserrat"},"üá≤üá¶":{domain:"ma",name:"Morocco"},"üá≤üáø":{domain:"mz",name:"Mozambique"},"üá≤üá≤":{domain:"mm",name:"Myanmar"},"üá≥üá¶":{domain:"na",name:"Namibia"},"üá≥üá∑":{domain:"nr",name:"Nauru"},"üá≥üáµ":{domain:"np",name:"Nepal"},"üá≥üá±":{domain:"nl",name:"Netherlands"},"üá≥üá®":{domain:"nc",name:"New Caledonia"},"üá≥üáø":{domain:"nz",name:"New Zealand"},"üá≥üáÆ":{domain:"ni",name:"Nicaragua"},"üá≥üá™":{domain:"ne",name:"Niger"},"üá≥üá¨":{domain:"ng",name:"Nigeria"},"üá≥üá∫":{domain:"nu",name:"Niue"},"üá≥üá´":{domain:"nf",name:"Norfolk Island"},"üá∞üáµ":{domain:"kp",name:"North Korea"},"üá≤üá∞":{domain:"mk",name:"North Macedonia"},"üá≤üáµ":{domain:"mp",name:"Northern Mariana Islands"},"üá≥üá¥":{domain:"no",name:"Norway"},"üá¥üá≤":{domain:"om",name:"Oman"},"üáµüá∞":{domain:"pk",name:"Pakistan"},"üáµüáº":{domain:"pw",name:"Palau"},"üáµüá∏":{domain:"ps",name:"Palestine"},"üáµüá¶":{domain:"pa",name:"Panama"},"üáµüá¨":{domain:"pg",name:"Papua New Guinea"},"üáµüáæ":{domain:"py",name:"Paraguay"},"üáµüá™":{domain:"pe",name:"Peru"},"üáµüá≠":{domain:"ph",name:"Philippines"},"üáµüá≥":{domain:"pn",name:"Pitcairn Islands"},"üáµüá±":{domain:"pl",name:"Poland"},"üáµüáπ":{domain:"pt",name:"Portugal"},"üáµüá∑":{domain:"pr",name:"Puerto Rico"},"üá∂üá¶":{domain:"qa",name:"Qatar"},"üá∑üá™":{domain:"re",name:"R√©union"},"üá∑üá¥":{domain:"ro",name:"Romania"},"üá∑üá∫":{domain:"ru",name:"Russia"},"üá∑üáº":{domain:"rw",name:"Rwanda"},"üáºüá∏":{domain:"ws",name:"Samoa"},"üá∏üá≤":{domain:"sm",name:"San Marino"},"üá∏üáπ":{domain:"st",name:"Sao Tome & Principe"},"üá∏üá¶":{domain:"sa",name:"Saudi Arabia"},"üá∏üá≥":{domain:"sn",name:"Senegal"},"üá∑üá∏":{domain:"rs",name:"Serbia"},"üá∏üá®":{domain:"sc",name:"Seychelles"},"üá∏üá±":{domain:"sl",name:"Sierra Leone"},"üá∏üá¨":{domain:"sg",name:"Singapore"},"üá∏üáΩ":{domain:"sx",name:"Sint Maarten"},"üá∏üá∞":{domain:"sk",name:"Slovakia"},"üá∏üáÆ":{domain:"si",name:"Slovenia"},"üá∏üáß":{domain:"sb",name:"Solomon Islands"},"üá∏üá¥":{domain:"so",name:"Somalia"},"üáøüá¶":{domain:"za",name:"South Africa"},"üá∞üá∑":{domain:"kr",name:"South Korea"},"üá™üá∏":{domain:"es",name:"Spain"},"üá±üá∞":{domain:"lk",name:"Sri Lanka"},"üá∏üá©":{domain:"sd",name:"Sudan"},"üá∏üá∑":{domain:"sr",name:"Suriname"},"üá∏üá™":{domain:"se",name:"Sweden"},"üá®üá≠":{domain:"ch",name:"Switzerland"},"üá∏üáæ":{domain:"sy",name:"Syria"},"üáπüáº":{domain:"tw",name:"Taiwan"},"üáπüáØ":{domain:"tj",name:"Tajikistan"},"üáπüáø":{domain:"tz",name:"Tanzania"},"üáπüá≠":{domain:"th",name:"Thailand"},"üáπüá±":{domain:"tl",name:"Timor-Leste"},"üáπüá¨":{domain:"tg",name:"Togo"},"üáπüá∞":{domain:"tk",name:"Tokelau"},"üáπüá¥":{domain:"to",name:"Tonga"},"üáπüáπ":{domain:"tt",name:"Trinidad & Tobago"},"üáπüá≥":{domain:"tn",name:"Tunisia"},"üáπüá∑":{domain:"tr",name:"Turkey"},"üáπüá≤":{domain:"tm",name:"Turkmenistan"},"üáπüá®":{domain:"tc",name:"Turks & Caicos Islands"},"üáπüáª":{domain:"tv",name:"Tuvalu"},"üá∫üá¨":{domain:"ug",name:"Uganda"},"üá∫üá¶":{domain:"ua",name:"Ukraine"},"üá¶üá™":{domain:"ae",name:"United Arab Emirates"},"üá¨üáß":{domain:"uk",name:"United Kingdom"},"üá∫üá∏":{domain:"us",name:"United States"},"üá∫üáæ":{domain:"uy",name:"Uruguay"},"üá∫üáø":{domain:"uz",name:"Uzbekistan"},"üáªüá∫":{domain:"vu",name:"Vanuatu"},"üáªüá¶":{domain:"va",name:"Vatican City"},"üáªüá™":{domain:"ve",name:"Venezuela"},"üáªüá≥":{domain:"vn",name:"Vietnam"},"üáºüá´":{domain:"wf",name:"Wallis & Futuna"},"üáæüá™":{domain:"ye",name:"Yemen"},"üáøüá≤":{domain:"zm",name:"Zambia"},"üáøüáº":{domain:"zw",name:"Zimbabwe"}};

/* –û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞ */
function cleanName(name) {
  return name
    .replace(/\[Not 24\/7\]/gi, 'üïõ')
    .replace(/\[Geo-blocked\]/gi, 'üåê')
    .replace(/Mozilla\/.*|like Gecko.*|Chrome\/.*|Safari\/\S+|CrKey\/\S+/gi, '')
    .replace(/\s+/g, ' ')
    .trim();
}

/* –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤ –∫—Ä—É–≥–ª—ã—Ö —Å–∫–æ–±–∫–∞—Ö */
function stripQuality(name) {
  return name.replace(/\(.*?\)/g, '').replace(/\s+/g, ' ').trim();
}

/* –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –ø–æ tvg-id: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º undefined –µ—Å–ª–∏ —Ñ–ª–∞–≥–∞ –Ω–µ—Ç */
function getFlagByTvgId(tvgId) {
  if (!tvgId) return undefined;
  const m = tvgId.toLowerCase().match(/\.([a-z]{2,})/);
  if (!m) return undefined;
  const code = m[1].replace(/[^a-z]/g, '');
  const flag = Object.keys(countryMap).find(e => countryMap[e].domain === code);
  return flag; // undefined –µ—Å–ª–∏ —Ñ–ª–∞–≥–∞ –Ω–µ—Ç
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ */
async function loadPlaylist(url) {
  try {
    const res = await fetch(url);
    const text = await res.text();
    parsePlaylist(text);
  } catch (e) {
    alert("Playlist Loading Error");
    console.error(e);
  }
}

/* –ü–∞—Ä—Å–∏–Ω–≥ m3u */
function parsePlaylist(text) {
  const lines = text.split(/\r?\n/);
  channels = [];
  let currentName = '';
  let currentTvgId = '';
  let currentLogoUrl = '';

  for (let line of lines) {
    if (line.startsWith('#EXTINF')) {
      let name = line.split(',').slice(1).join(',');
      currentName = cleanName(name);
      const mId = line.match(/tvg-id="([^"]+)"/i);
      currentTvgId = mId ? mId[1] : '';
      const mLogo = line.match(/tvg-logo="([^"]+)"/i);
      currentLogoUrl = mLogo ? mLogo[1] : '';
    } else if (line && !line.startsWith('#')) {
      if (currentName) {
        const flag = getFlagByTvgId(currentTvgId);
        if (!flag) { // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–Ω–∞–ª—ã –±–µ–∑ —Ñ–ª–∞–≥–∞
          currentName = '';
          currentTvgId = '';
          currentLogoUrl = '';
          continue;
        }
        const displayName = stripQuality(currentName);
        channels.push({
          name: currentName,
          displayName,
          url: line,
          tvgId: currentTvgId,
          logo: currentLogoUrl,
          flag
        });
      }
      currentName = '';
      currentTvgId = '';
      currentLogoUrl = '';
    }
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –ø–µ—Ä–≤—ã–º (–∞ –Ω–µ –∫–∞–Ω–∞–ª—ã)
  renderCountries();
  searchInput.focus();
}

/* –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω (—Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–∞–Ω—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–∞–Ω–∞–ª—ã) */
function renderCountries(filter = '') {
  currentCountry = undefined;
  backBtn.style.display = 'none';
  searchInput.placeholder = "Filter Countries";
  list.innerHTML = '';
  list.scrollTop = 0;

  // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –∏–∑ channels
  const flagSet = new Set(channels.map(c => c.flag).filter(Boolean));
  let flags = Array.from(flagSet).map(f => ({ flag: f, name: countryMap[f] ? countryMap[f].name : f }));

  // –∞–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω
  flags.sort((a, b) => a.name.localeCompare(b.name, 'en', { sensitivity: 'base' }));

  const filtered = flags.filter(fObj => fObj.name.toLowerCase().includes(filter.toLowerCase()));

  filtered.forEach((fObj) => {
    const div = document.createElement('div');
    div.className = 'channel';
    div.dataset.type = 'country';
    div.dataset.flag = fObj.flag;

    const spanFlag = document.createElement('span');
    spanFlag.className = 'channel-flag';
    spanFlag.textContent = fObj.flag;

    const spanText = document.createElement('span');
    spanText.className = 'channel-text';
    spanText.textContent = fObj.name;

    div.appendChild(spanFlag);
    div.appendChild(spanText);

    div.onclick = () => {
      // –æ—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã —Å—Ç—Ä–∞–Ω—ã
      searchInput.value = '';
      renderChannels(fObj.flag);

      // –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å–ø–∏—Å–∫–∞
      const firstChannelEl = list.querySelector('.channel[data-type="channel"]');
      if (firstChannelEl) {
        const idx = parseInt(firstChannelEl.dataset.index, 10);
        const ch = channels[idx];
        if (ch) playChannel(idx, firstChannelEl, ch);
      }

      // —Å—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å –≤ –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤
      searchInput.focus();
    };

    list.appendChild(div);
  });

  if (window.twemoji) {
    try { twemoji.parse(list, {folder: 'svg', ext: '.svg'}); } 
    catch (e) { console.warn("twemoji parse error", e); }
  }
}

/* –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã */
function renderChannels(countryFlag = undefined, filter = '') {
  currentCountry = countryFlag;
  backBtn.style.display = countryFlag ? 'inline-block' : 'none';
  searchInput.placeholder = countryFlag ? "Filter Channels" : "Filter Channels";
  list.innerHTML = '';
  list.scrollTop = 0;

  const filtered = channels.filter(ch => {
    if (countryFlag && ch.flag !== countryFlag) return false;
    return ch.displayName.toLowerCase().includes(filter.toLowerCase());
  });

  filtered.forEach((ch) => {
    const div = document.createElement('div');
    div.className = 'channel';
    div.dataset.type = 'channel';
    // store index to identify channel in main channels array
    const idx = channels.indexOf(ch);
    div.dataset.index = idx;

    const spanFlag = document.createElement('span');
    spanFlag.className = 'channel-flag';
    spanFlag.textContent = ch.flag;

    const spanText = document.createElement('span');
    spanText.className = 'channel-text';
    spanText.textContent = ch.displayName.replace(/[üïõüåê]/g, '').trim();

    const spanEmoji = document.createElement('span');
    spanEmoji.className = 'channel-emoji';
    let emojis = '';
    if (ch.name.includes('üïõ')) emojis += 'üïõ';
    if (ch.name.includes('üåê')) emojis += 'üåê';
    spanEmoji.textContent = emojis;

    div.appendChild(spanFlag);
    div.appendChild(spanText);
    if (emojis) div.appendChild(spanEmoji);

    div.onclick = () => {
      playChannel(idx, div, ch);
    };

    list.appendChild(div);
  });

  if (window.twemoji) {
    try { twemoji.parse(list, {folder: 'svg', ext: '.svg'}); } 
    catch (e) { console.warn("twemoji parse error", e); }
  }
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
function updateNowPlayingUI(channelObj) {
  if (channelObj.logo) {
    currentLogo.src = channelObj.logo;
    currentLogo.style.visibility = 'visible';
  } else {
    currentLogo.removeAttribute('src');
    currentLogo.style.visibility = 'hidden';
  }
  // –ø–∏—à–µ–º —Å—Ç—Ä–∞–Ω—É –≤–º–µ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞
  const countryName = countryMap[channelObj.flag]?.name || '';
  currentTitle.textContent = countryName;
}

/* –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ */
function playChannel(index, element, channelObj) {
  document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
  if (element) element.classList.add('active');

  const ch = (channelObj ? channelObj : channels[index]);
  if (!ch || !ch.url) return;

  updateNowPlayingUI(ch);

  if (Hls.isSupported()) {
    if (!hls) hls = new Hls();
    else hls.detachMedia();
    hls.loadSource(ch.url);
    hls.attachMedia(player);
    hls.on(Hls.Events.MANIFEST_PARSED, function() {
      player.play().catch(()=>{});
    });
  } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
    player.src = ch.url;
    player.play().catch(()=>{});
  } else {
    alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HLS");
  }
}

/* –ü–æ–∏—Å–∫ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º: —Å—Ç—Ä–∞–Ω—ã –∏–ª–∏ –∫–∞–Ω–∞–ª—ã) */
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim();
  if (currentCountry === undefined) {
    renderCountries(q);
  } else {
    renderChannels(currentCountry, q);
  }
  list.scrollTop = 0;
});

/* –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É —Å—Ç—Ä–∞–Ω */
backBtn.addEventListener('click', () => {
  // –æ—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω—ã
  searchInput.value = '';
  renderCountries('');
});

/* –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä */
randomBtn.onclick = () => {
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  const visible = Array.from(document.querySelectorAll('#channelList .channel'));
  if (visible.length === 0) return;

  // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤–∏–¥–∏–º—ã–µ –∫–∞–Ω–∞–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞–Ω—É
  const channelEls = visible.filter(el => el.dataset.type === 'channel');
  if (channelEls.length > 0) {
    const idxVisible = Math.floor(Math.random() * channelEls.length);
    const el = channelEls[idxVisible];
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –í –°–ê–ú–´–• –í–ï–†–•–£ —Å–ø–∏—Å–∫–∞
    el.scrollIntoView({ behavior: 'auto', block: 'start' });

    const chIndex = parseInt(el.dataset.index, 10);
    const ch = channels[chIndex];
    if (ch) {
      playChannel(chIndex, el, ch);
    }
    return;
  }

  // –ù–µ—Ç –≤–∏–¥–∏–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–∞–Ω—É (–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ—ë)
  const countryEls = visible.filter(el => el.dataset.type === 'country');
  if (countryEls.length === 0) return;
  const idxCountry = Math.floor(Math.random() * countryEls.length);
  const countryEl = countryEls[idxCountry];
  countryEl.click();
};

/* –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
window.addEventListener('DOMContentLoaded', () => {
  fetch("data/channels.json")
  .then(r => r.json())
  .then(data => {
    channels = data.filter(ch => ch.working); // —Å—Ä–∞–∑—É –æ—Ç—Å–µ–∫–∞–µ–º –±–∏—Ç—ã–µ
    renderCountries();
  });
});
</script>
</body>
</html>
