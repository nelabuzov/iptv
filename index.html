<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>IPTV Player</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
<style>
  body { margin: 0; font-family: sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; height: 100vh; }
  header { display: flex; justify-content: space-between; align-items: center; padding: 0 10px; background: #1e1e1e; gap: 10px; }
  #nowPlaying { display: flex; align-items: center; min-width: 0; margin-left: -10px; }
  #currentLogo { display: block; height: 50px; width: auto; margin: 0; padding: 0; }
  /* –æ–±–Ω–æ–≤–ª–µ–Ω–æ */
  #currentTitle {
    margin-left: 10px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 50vw;
    color: #1e1e1e; background: #444; padding: 6px; border-radius: 12px; text-transform: uppercase;
  }
  #emojiDescription { font-size: 14px; opacity: 0.8; white-space: nowrap; }
  main { display: flex; flex: 1; overflow: hidden; }
  #playerContainer { flex: 3; display: flex; align-items: center; justify-content: center; background: black; }
  video { width: 100%; height: 100%; background: black; }
  video::-webkit-media-controls-timeline,
  video::-webkit-media-controls-time-remaining-display,
  video::-webkit-media-controls-current-time-display { display: none !important; }
  #rightPanel { flex: 1; background: #181818; display: flex; flex-direction: column; overflow: hidden; }
  #tools { display: flex; gap: 8px; padding: 10px; background: #1e1e1e; align-items: center; }
  #searchInput { flex: 1; padding: 6px; border-radius: 12px; border: none; outline: none; background: #2a2a2a; color: white; }
  #randomBtn, #backBtn { padding: 6px 10px; border: none; border-radius: 12px; background: #333; color: white; cursor: pointer; }
  #backBtn { display: none; }
  #channelList { flex: 1; overflow-y: auto; padding: 0 10px; }
  .channel { display: flex; align-items: center; padding: 12px; border-radius: 12px; cursor: pointer; gap: 8px; margin: 0; }
  .channel:hover { background: #333; }
  .channel.active { background: #444; }
  .channel-flag { flex-shrink: 0; font-size: 16px; line-height: 1; width: 30px; display: flex; align-items: center; justify-content: center; }
  .channel-flag img { width: 18px; height: 18px; display: block; }
  .channel-text { flex: 1; word-break: break-word; }
  .channel-emoji { flex-shrink: 0; font-size: 16px; margin-left: 8px; display: flex; align-items: center; }
  .channel-emoji img { width: 16px; height: 16px; display: block; }
  #channelList::-webkit-scrollbar { width: 8px; }
  #channelList::-webkit-scrollbar-thumb { background: #444; border-radius: 8px; }
  #channelList::-webkit-scrollbar-track { background: transparent; }
</style>
</head>
<body>
  <header>
    <div id="nowPlaying">
      <img id="currentLogo" alt="" src="" />
      <div id="currentTitle"></div>
    </div>
    <div id="emojiDescription">
      üïõ ‚Äî Not 24/7 &nbsp;&nbsp; üåê ‚Äî Geo-blocked
    </div>
  </header>
  <main>
    <div id="playerContainer">
      <video id="videoPlayer" controls autoplay></video>
    </div>
    <div id="rightPanel">
      <div id="tools">
        <button id="backBtn">‚óÄ</button>
        <input id="searchInput" type="text" placeholder="Filter Countries">
        <button id="randomBtn">üé≤</button>
      </div>
      <div id="channelList"></div>
    </div>
  </main>

<script>
const list = document.getElementById('channelList');
const player = document.getElementById('videoPlayer');
const searchInput = document.getElementById('searchInput');
const randomBtn = document.getElementById('randomBtn');
const backBtn = document.getElementById('backBtn');
const currentLogo = document.getElementById('currentLogo');
const currentTitle = document.getElementById('currentTitle');

let channels = [];
let hls = null;
let currentCountry = undefined; // undefined => –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã

/* === countryMap (–º–∏–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ JS) === */
const countryMap={"üá¶üá´":{domain:"af",name:"Afghanistan"},"üáøüáº":{domain:"zw",name:"Zimbabwe"}...};

/* –û—á–∏—Å—Ç–∫–∞ –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞ */
function cleanName(name) {
  return name
    .replace(/\[Not 24\/7\]/gi, 'üïõ')
    .replace(/\[Geo-blocked\]/gi, 'üåê')
    .replace(/Mozilla\/.*|like Gecko.*|Chrome\/.*|Safari\/\S+|CrKey\/\S+/gi, '')
    .replace(/\s+/g, ' ')
    .trim();
}

/* –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≤ –∫—Ä—É–≥–ª—ã—Ö —Å–∫–æ–±–∫–∞—Ö */
function stripQuality(name) {
  return name.replace(/\(.*?\)/g, '').replace(/\s+/g, ' ').trim();
}

/* –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –ø–æ tvg-id: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º undefined –µ—Å–ª–∏ —Ñ–ª–∞–≥–∞ –Ω–µ—Ç */
function getFlagByTvgId(tvgId) {
  if (!tvgId) return undefined;
  const m = tvgId.toLowerCase().match(/\.([a-z]{2,})/);
  if (!m) return undefined;
  const code = m[1].replace(/[^a-z]/g, '');
  const flag = Object.keys(countryMap).find(e => countryMap[e].domain === code);
  return flag; // undefined –µ—Å–ª–∏ —Ñ–ª–∞–≥–∞ –Ω–µ—Ç
}

/* –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ */
async function loadPlaylist(url) {
  try {
    const res = await fetch(url);
    const text = await res.text();
    parsePlaylist(text);
  } catch (e) {
    alert("Playlist Loading Error");
    console.error(e);
  }
}

/* –ü–∞—Ä—Å–∏–Ω–≥ m3u */
function parsePlaylist(text) {
  const lines = text.split(/\r?\n/);
  channels = [];
  let currentName = '';
  let currentTvgId = '';
  let currentLogoUrl = '';

  for (let line of lines) {
    if (line.startsWith('#EXTINF')) {
      let name = line.split(',').slice(1).join(',');
      currentName = cleanName(name);
      const mId = line.match(/tvg-id="([^"]+)"/i);
      currentTvgId = mId ? mId[1] : '';
      const mLogo = line.match(/tvg-logo="([^"]+)"/i);
      currentLogoUrl = mLogo ? mLogo[1] : '';
    } else if (line && !line.startsWith('#')) {
      if (currentName) {
        const flag = getFlagByTvgId(currentTvgId);
        if (!flag) { // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–Ω–∞–ª—ã –±–µ–∑ —Ñ–ª–∞–≥–∞
          currentName = '';
          currentTvgId = '';
          currentLogoUrl = '';
          continue;
        }
        const displayName = stripQuality(currentName);
        channels.push({
          name: currentName,
          displayName,
          url: line,
          tvgId: currentTvgId,
          logo: currentLogoUrl,
          flag
        });
      }
      currentName = '';
      currentTvgId = '';
      currentLogoUrl = '';
    }
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω –ø–µ—Ä–≤—ã–º (–∞ –Ω–µ –∫–∞–Ω–∞–ª—ã)
  renderCountries();
  searchInput.focus();
}

/* –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å—Ç—Ä–∞–Ω (—Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–∞–Ω—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–∞–Ω–∞–ª—ã) */
function renderCountries(filter = '') {
  currentCountry = undefined;
  backBtn.style.display = 'none';
  searchInput.placeholder = "Filter Countries";
  list.innerHTML = '';
  list.scrollTop = 0;

  // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –∏–∑ channels
  const flagSet = new Set(channels.map(c => c.flag).filter(Boolean));
  let flags = Array.from(flagSet).map(f => ({ flag: f, name: countryMap[f] ? countryMap[f].name : f }));

  // –∞–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω
  flags.sort((a, b) => a.name.localeCompare(b.name, 'en', { sensitivity: 'base' }));

  const filtered = flags.filter(fObj => fObj.name.toLowerCase().includes(filter.toLowerCase()));

  filtered.forEach((fObj) => {
    const div = document.createElement('div');
    div.className = 'channel';
    div.dataset.type = 'country';
    div.dataset.flag = fObj.flag;

    const spanFlag = document.createElement('span');
    spanFlag.className = 'channel-flag';
    spanFlag.textContent = fObj.flag;

    const spanText = document.createElement('span');
    spanText.className = 'channel-text';
    spanText.textContent = fObj.name;

    div.appendChild(spanFlag);
    div.appendChild(spanText);

    div.onclick = () => {
      // –æ—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã —Å—Ç—Ä–∞–Ω—ã
      searchInput.value = '';
      renderChannels(fObj.flag);

      // –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å–ø–∏—Å–∫–∞
      const firstChannelEl = list.querySelector('.channel[data-type="channel"]');
      if (firstChannelEl) {
        const idx = parseInt(firstChannelEl.dataset.index, 10);
        const ch = channels[idx];
        if (ch) playChannel(idx, firstChannelEl, ch);
      }

      // —Å—Ç–∞–≤–∏–º —Ñ–æ–∫—É—Å –≤ –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤
      searchInput.focus();
    };

    list.appendChild(div);
  });

  if (window.twemoji) {
    try { twemoji.parse(list, {folder: 'svg', ext: '.svg'}); } 
    catch (e) { console.warn("twemoji parse error", e); }
  }
}

/* –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã */
function renderChannels(countryFlag = undefined, filter = '') {
  currentCountry = countryFlag;
  backBtn.style.display = countryFlag ? 'inline-block' : 'none';
  searchInput.placeholder = countryFlag ? "Filter Channels" : "Filter Channels";
  list.innerHTML = '';
  list.scrollTop = 0;

  const filtered = channels.filter(ch => {
    if (countryFlag && ch.flag !== countryFlag) return false;
    return ch.displayName.toLowerCase().includes(filter.toLowerCase());
  });

  filtered.forEach((ch) => {
    const div = document.createElement('div');
    div.className = 'channel';
    div.dataset.type = 'channel';
    // store index to identify channel in main channels array
    const idx = channels.indexOf(ch);
    div.dataset.index = idx;

    const spanFlag = document.createElement('span');
    spanFlag.className = 'channel-flag';
    spanFlag.textContent = ch.flag;

    const spanText = document.createElement('span');
    spanText.className = 'channel-text';
    spanText.textContent = ch.displayName.replace(/[üïõüåê]/g, '').trim();

    const spanEmoji = document.createElement('span');
    spanEmoji.className = 'channel-emoji';
    let emojis = '';
    if (ch.name.includes('üïõ')) emojis += 'üïõ';
    if (ch.name.includes('üåê')) emojis += 'üåê';
    spanEmoji.textContent = emojis;

    div.appendChild(spanFlag);
    div.appendChild(spanText);
    if (emojis) div.appendChild(spanEmoji);

    div.onclick = () => {
      playChannel(idx, div, ch);
    };

    list.appendChild(div);
  });

  if (window.twemoji) {
    try { twemoji.parse(list, {folder: 'svg', ext: '.svg'}); } 
    catch (e) { console.warn("twemoji parse error", e); }
  }
}

/* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
function updateNowPlayingUI(channelObj) {
  if (channelObj.logo) {
    currentLogo.src = channelObj.logo;
    currentLogo.style.visibility = 'visible';
  } else {
    currentLogo.removeAttribute('src');
    currentLogo.style.visibility = 'hidden';
  }
  // –ø–∏—à–µ–º —Å—Ç—Ä–∞–Ω—É –≤–º–µ—Å—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞
  const countryName = countryMap[channelObj.flag]?.name || '';
  currentTitle.textContent = countryName;
}

/* –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ */
function playChannel(index, element, channelObj) {
  document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
  if (element) element.classList.add('active');

  const ch = (channelObj ? channelObj : channels[index]);
  if (!ch || !ch.url) return;

  updateNowPlayingUI(ch);

  if (Hls.isSupported()) {
    if (!hls) hls = new Hls();
    else hls.detachMedia();
    hls.loadSource(ch.url);
    hls.attachMedia(player);
    hls.on(Hls.Events.MANIFEST_PARSED, function() {
      player.play().catch(()=>{});
    });
  } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
    player.src = ch.url;
    player.play().catch(()=>{});
  } else {
    alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç HLS");
  }
}

/* –ü–æ–∏—Å–∫ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∂–∏–º: —Å—Ç—Ä–∞–Ω—ã –∏–ª–∏ –∫–∞–Ω–∞–ª—ã) */
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim();
  if (currentCountry === undefined) {
    renderCountries(q);
  } else {
    renderChannels(currentCountry, q);
  }
  list.scrollTop = 0;
});

/* –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É —Å—Ç—Ä–∞–Ω */
backBtn.addEventListener('click', () => {
  // –æ—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω—ã
  searchInput.value = '';
  renderCountries('');
});

/* –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä */
randomBtn.onclick = () => {
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  const visible = Array.from(document.querySelectorAll('#channelList .channel'));
  if (visible.length === 0) return;

  // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤–∏–¥–∏–º—ã–µ –∫–∞–Ω–∞–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å), –∏–Ω–∞—á–µ –≤—ã–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞–Ω—É
  const channelEls = visible.filter(el => el.dataset.type === 'channel');
  if (channelEls.length > 0) {
    const idxVisible = Math.floor(Math.random() * channelEls.length);
    const el = channelEls[idxVisible];
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –í –°–ê–ú–´–• –í–ï–†–•–£ —Å–ø–∏—Å–∫–∞
    el.scrollIntoView({ behavior: 'auto', block: 'start' });

    const chIndex = parseInt(el.dataset.index, 10);
    const ch = channels[chIndex];
    if (ch) {
      playChannel(chIndex, el, ch);
    }
    return;
  }

  // –ù–µ—Ç –≤–∏–¥–∏–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ ‚Äî –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–∞–Ω—É (–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ—ë)
  const countryEls = visible.filter(el => el.dataset.type === 'country');
  if (countryEls.length === 0) return;
  const idxCountry = Math.floor(Math.random() * countryEls.length);
  const countryEl = countryEls[idxCountry];
  countryEl.click();
};

/* –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–µ–π–ª–∏—Å—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ */
window.addEventListener('DOMContentLoaded', () => {
  fetch("data/channels.json")
  .then(r => r.json())
  .then(data => {
    channels = data.filter(ch => ch.working); // —Å—Ä–∞–∑—É –æ—Ç—Å–µ–∫–∞–µ–º –±–∏—Ç—ã–µ
    renderCountries();
  });
});
</script>
</body>
</html>
